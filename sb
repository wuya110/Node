#!/bin/bash

# =========================================================
# Sing-box å®Œç¾åŒæ ¸ç‰ˆ (Reality + Hy2) - V2.1 æœ€ç»ˆä¿®å¤ç‰ˆ
# =========================================================
# ç‰¹æ€§ï¼š
# 1. å®˜æ–¹å†…æ ¸è‡ªåŠ¨æ›´æ–°
# 2. è‡ªåŠ¨ä¿®å¤ acme.sh ZeroSSL æ³¨å†Œé—®é¢˜
# 3. æ¯æ—¥å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨æ¸…ç†ç³»ç»Ÿåƒåœ¾
# 4. å®Œæ•´çš„ç«¯å£è·³è·ƒä¸ä¼ªè£…ç®¡ç†
# =========================================================

# é¢œè‰²å®šä¹‰
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[36m"
PLAIN="\033[0m"

# æ ¸å¿ƒé…ç½®è·¯å¾„
SB_CONFIG="/etc/sing-box/config.json"
SB_BIN="/usr/local/bin/sing-box"
CERT_DIR="/root/cert"
DOMAIN_FILE="/etc/sing-box/domain.txt"
SCRIPT_PATH=$(readlink -f "$0")

# æ£€æŸ¥ Root æƒé™
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼šå¿…é¡»ä½¿ç”¨ Root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼${PLAIN}" && exit 1

# -----------------------------------------------------------------------------
# åŸºç¡€åŠŸèƒ½å‡½æ•°
# -----------------------------------------------------------------------------

# 1. å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${BLUE}æ­£åœ¨å®‰è£…å¿…è¦ä¾èµ–...${PLAIN}"
    # å¢åŠ  net-tools ä»¥ä¿®å¤ netstat æŠ¥é”™
    if [ -f /etc/debian_version ]; then
        apt update -y && apt install -y curl wget tar socat jq openssl cron iptables iptables-persistent net-tools
    elif [ -f /etc/redhat-release ]; then
        yum install -y curl wget tar socat jq openssl cronie iptables iptables-services net-tools
    fi
    mkdir -p /etc/sing-box
    
    # ç¡®ä¿ cron æœåŠ¡å¼€å¯
    systemctl enable cron >/dev/null 2>&1
    systemctl start cron >/dev/null 2>&1
}

# 2. ç³»ç»Ÿåƒåœ¾æ¸…ç† (æ”¯æŒåå°é™é»˜è¿è¡Œ)
system_cleanup() {
    echo -e "${BLUE}æ­£åœ¨æ‰§è¡Œç³»ç»Ÿæ¸…ç†...${PLAIN}"
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y >/dev/null 2>&1
        apt-get clean >/dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y >/dev/null 2>&1
        yum clean all >/dev/null 2>&1
    fi
    # æ¸…ç†æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
    rm -rf /tmp/*
    rm -rf /var/log/*.gz
    rm -rf /root/.npm
    rm -rf /root/.cache
    rm -f /tmp/sb.tar.gz
}

# 3. å®‰è£…/æ›´æ–°å®˜æ–¹å†…æ ¸
install_core() {
    echo -e "${BLUE}æ­£åœ¨æ£€æŸ¥ Sing-box å®˜æ–¹æœ€æ–°ç‰ˆæœ¬...${PLAIN}"
    LATEST_VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep 'tag_name' | cut -d\" -f4 | sed 's/v//')
    
    if [[ -z "$LATEST_VER" ]]; then
        echo -e "${RED}è·å–ç‰ˆæœ¬å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥${PLAIN}"
        return 1
    fi
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH_STR="amd64" ;;
        aarch64) ARCH_STR="arm64" ;;
        *) echo -e "${RED}ä¸æ”¯æŒçš„æ¶æ„: $ARCH${PLAIN}"; return 1 ;;
    esac

    echo -e "${GREEN}æ£€æµ‹åˆ°ç‰ˆæœ¬: v${LATEST_VER}ï¼Œå¼€å§‹ä¸‹è½½...${PLAIN}"
    wget -O /tmp/sb.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VER}/sing-box-${LATEST_VER}-linux-${ARCH_STR}.tar.gz"
    
    tar -zxvf /tmp/sb.tar.gz -C /tmp
    mv /tmp/sing-box-${LATEST_VER}-linux-${ARCH_STR}/sing-box $SB_BIN
    chmod +x $SB_BIN
    rm -rf /tmp/sb.tar.gz /tmp/sing-box*
    echo -e "${GREEN}å†…æ ¸å®‰è£…æˆåŠŸï¼${PLAIN}"
}

# 4. ç”³è¯·è¯ä¹¦ (ä¿®å¤ ZeroSSL æ³¨å†Œé—®é¢˜)
get_acme_cert() {
    local domain=$1
    echo -e "${BLUE}æ­£åœ¨å‡†å¤‡ç”³è¯· SSL è¯ä¹¦...${PLAIN}"
    
    # é‡Šæ”¾ 80 ç«¯å£
    if netstat -tuln | grep -q ":80 "; then
        echo -e "${YELLOW}æ£€æµ‹åˆ° 80 ç«¯å£å ç”¨ï¼Œä¸´æ—¶é‡Šæ”¾...${PLAIN}"
        systemctl stop nginx 2>/dev/null
        systemctl stop apache2 2>/dev/null
    fi

    # å®‰è£… acme.sh
    curl https://get.acme.sh | sh
    ~/.acme.sh/acme.sh --upgrade --auto-upgrade
    
    # å…³é”®ä¿®å¤ï¼šåˆ‡æ¢ CA ä¸º Let's Encrypt å¹¶æ³¨å†Œè´¦å·
    # è¿™æ­¥èƒ½è§£å†³ "Please update your account with an email address" æŠ¥é”™
    echo -e "${BLUE}åˆ‡æ¢ CA è‡³ Let's Encrypt...${PLAIN}"
    ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
    ~/.acme.sh/acme.sh --register-account -m "admin@${domain}"

    # ç”³è¯·è¯ä¹¦
    mkdir -p $CERT_DIR
    ~/.acme.sh/acme.sh --issue -d "$domain" --standalone --force
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}è¯ä¹¦ç”³è¯·å¤±è´¥ï¼è¯·æ£€æŸ¥åŸŸåè§£ææ˜¯å¦æ­£ç¡®ã€‚${PLAIN}"
        exit 1
    fi

    # å®‰è£…è¯ä¹¦
    ~/.acme.sh/acme.sh --install-cert -d "$domain" \
        --key-file       $CERT_DIR/private.key  \
        --fullchain-file $CERT_DIR/cert.crt
    
    echo -e "${GREEN}è¯ä¹¦ç”³è¯·æˆåŠŸï¼${PLAIN}"
}

# 5. é…ç½®ç«¯å£è·³è·ƒ (IPtables)
setup_port_hopping() {
    local port=$1
    local range_start=$2
    local range_end=$3
    
    echo -e "${BLUE}é…ç½®é˜²ç«å¢™ç«¯å£è·³è·ƒè§„åˆ™...${PLAIN}"
    iptables -t nat -F PREROUTING
    if [[ -n "$range_start" ]]; then
        iptables -t nat -A PREROUTING -p udp --dport ${range_start}:${range_end} -j REDIRECT --to-ports ${port}
    fi
    netfilter-persistent save 2>/dev/null || service iptables save 2>/dev/null
}

# 6. ç”Ÿæˆ Sing-box é…ç½®æ–‡ä»¶
generate_config() {
    local domain=$1; local camou_dest=$2; local hy2_port=$3
    local hy2_pass=$4; local obfs_pass=$5; local uuid=$6
    local private_key=$7; local short_id=$8

    cat > $SB_CONFIG <<JSON
{
  "log": { "level": "info", "timestamp": true },
  "inbounds": [
    {
      "type": "vless",
      "tag": "vless-reality",
      "listen": "::",
      "listen_port": 443,
      "users": [{ "uuid": "$uuid", "flow": "xtls-rprx-vision" }],
      "tls": {
        "enabled": true,
        "server_name": "$camou_dest",
        "reality": {
          "enabled": true,
          "handshake": { "server": "$camou_dest", "server_port": 443 },
          "private_key": "$private_key",
          "short_id": ["$short_id"]
        }
      }
    },
    {
      "type": "hysteria2",
      "tag": "hy2-in",
      "listen": "::",
      "listen_port": $hy2_port,
      "users": [{ "password": "$hy2_pass" }],
      "obfs": { "type": "salamander", "password": "$obfs_pass" },
      "tls": {
        "enabled": true,
        "alpn": ["h3"],
        "certificate_path": "$CERT_DIR/cert.crt",
        "key_path": "$CERT_DIR/private.key"
      }
    }
  ],
  "outbounds": [{ "type": "direct", "tag": "direct" }]
}
JSON
}

# 7. é…ç½®å¼€æœºè‡ªå¯æœåŠ¡
setup_service() {
    cat > /etc/systemd/system/sing-box.service <<EOF
[Unit]
Description=sing-box service
After=network.target nss-lookup.target
[Service]
ExecStart=$SB_BIN run -c $SB_CONFIG
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable sing-box >/dev/null 2>&1
    systemctl restart sing-box
}

# -----------------------------------------------------------------------------
# äº¤äº’æµç¨‹
# -----------------------------------------------------------------------------

# ä¸»å®‰è£…å‡½æ•°
install_singbox() {
    install_dependencies
    install_core
    
    # æ³¨å†Œå¿«æ·å‘½ä»¤ sb (æŒ‡å‘å½“å‰è„šæœ¬)
    # å¦‚æœæ˜¯ä» GitHub ä¸‹è½½æ‰§è¡Œï¼Œå°†è„šæœ¬ä¿å­˜åˆ°æœ¬åœ°
    if [[ "$0" != "/usr/local/bin/sb" ]]; then
        cp "$SCRIPT_PATH" /usr/local/bin/sb
        chmod +x /usr/local/bin/sb
    fi

    # Hy2 åŸŸåé…ç½®
    echo -e "\n${YELLOW}[Hysteria 2 é…ç½®]${PLAIN}"
    read -p "è¯·è¾“å…¥è§£æåˆ°æœ¬æœºçš„åŸŸå (å¿…å¡«): " domain
    [[ -z "$domain" ]] && echo -e "${RED}åŸŸåä¸èƒ½ä¸ºç©ºï¼${PLAIN}" && exit 1
    echo "$domain" > $DOMAIN_FILE
    
    # ç”³è¯·è¯ä¹¦
    get_acme_cert "$domain"

    # Hy2 ç«¯å£é…ç½®
    read -p "è®¾ç½® Hy2 ä¸»ç«¯å£ (é»˜è®¤ 50000): " hy2_port
    [[ -z "$hy2_port" ]] && hy2_port=50000
    
    read -p "è®¾ç½®ç«¯å£è·³è·ƒèŒƒå›´ (å¦‚ 50000-50050ï¼Œç•™ç©ºåˆ™ä¸å¼€å¯): " port_range
    [[ -n "$port_range" ]] && setup_port_hopping $hy2_port ${port_range%-*} ${port_range#*-}

    # ç”Ÿæˆéšæœºå¯†ç 
    hy2_pass=$(openssl rand -hex 8)
    obfs_pass=$(openssl rand -hex 8)

    # Reality ä¼ªè£…é…ç½®
    echo -e "\n${YELLOW}[VLESS-Reality é…ç½®]${PLAIN}"
    echo "1. www.microsoft.com (å¾®è½¯ - æ¨è)"
    echo "2. www.amazon.com (äºšé©¬é€Š)"
    echo "3. www.tesla.com (ç‰¹æ–¯æ‹‰)"
    read -p "é€‰æ‹©ä¼ªè£…ç›®æ ‡ [1-3] (é»˜è®¤1): " dest_idx
    case $dest_idx in
        2) dest="www.amazon.com" ;;
        3) dest="www.tesla.com" ;;
        *) dest="www.microsoft.com" ;;
    esac

    # ç”Ÿæˆ Reality å¯†é’¥
    kp=$($SB_BIN generate reality-keypair)
    pk=$(echo "$kp" | grep "PrivateKey" | cut -d: -f2 | tr -d ' "')
    pub=$(echo "$kp" | grep "PublicKey" | cut -d: -f2 | tr -d ' "')
    sid=$($SB_BIN generate rand --hex 8)
    uuid=$($SB_BIN generate uuid)

    # ç”Ÿæˆé…ç½®å¹¶å¯åŠ¨
    generate_config "$domain" "$dest" "$hy2_port" "$hy2_pass" "$obfs_pass" "$uuid" "$pk" "$sid"
    setup_service
    
    # ä¿å­˜å®‰è£…ä¿¡æ¯
    cat > /etc/sing-box/info.txt <<EOF
DOMAIN=$domain
UUID=$uuid
PUBLIC_KEY=$pub
SHORT_ID=$sid
CAMOU_DEST=$dest
HY2_PORT=$hy2_port
HY2_PASS=$hy2_pass
OBFS_PASS=$obfs_pass
PORT_RANGE=$port_range
EOF
    
    # æ·»åŠ æ¯æ—¥è‡ªåŠ¨æ¸…ç†ä»»åŠ¡ (æ¯å¤©å‡Œæ™¨ 3 ç‚¹)
    (crontab -l 2>/dev/null | grep -v "sb cleanup"; echo "0 3 * * * /usr/local/bin/sb cleanup") | crontab -
    
    echo -e "${GREEN}å®‰è£…å®Œæˆï¼å·²æ·»åŠ æ¯æ—¥è‡ªåŠ¨æ¸…ç†ä»»åŠ¡ã€‚${PLAIN}"
    show_info
}

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
show_info() {
    [[ ! -f /etc/sing-box/info.txt ]] && echo -e "${RED}è¯·å…ˆå®‰è£…ï¼${PLAIN}" && return
    source /etc/sing-box/info.txt
    ip=$(curl -s4 icanhazip.com)
    
    vless_link="vless://${UUID}@${ip}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=${CAMOU_DEST}&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#VLESS-Reality"
    hy2_link="hysteria2://${HY2_PASS}@${DOMAIN}:${HY2_PORT}?sni=${DOMAIN}&alpn=h3&obfs=salamander&obfs-password=${OBFS_PASS}&insecure=0#Hy2-Link"

    echo -e "\n${BLUE}ğŸš€ VLESS-Reality èŠ‚ç‚¹${PLAIN}"
    echo -e "åœ°å€: ${ip}:443"
    echo -e "ä¼ªè£…: ${CAMOU_DEST}"
    echo -e "UUID: ${UUID}"
    echo -e "é“¾æ¥: ${vless_link}"

    echo -e "\n${BLUE}ğŸš€ Hysteria 2 èŠ‚ç‚¹${PLAIN}"
    echo -e "åŸŸå: ${DOMAIN}"
    echo -e "ç«¯å£: ${HY2_PORT} (è·³è·ƒèŒƒå›´: ${PORT_RANGE})"
    echo -e "å¯†ç : ${HY2_PASS}"
    echo -e "æ··æ·†: ${OBFS_PASS}"
    echo -e "é“¾æ¥: ${hy2_link}"
}

# ä¿®æ”¹é…ç½®åŠŸèƒ½
modify_config() {
    [[ ! -f /etc/sing-box/info.txt ]] && echo "è¯·å…ˆå®‰è£…" && return
    source /etc/sing-box/info.txt
    
    echo -e "\n${YELLOW}[ä¿®æ”¹é…ç½®]${PLAIN}"
    echo " 1. ä¿®æ”¹ Reality ä¼ªè£…åŸŸå"
    echo " 2. ä¿®æ”¹ Hy2 ç«¯å£/è·³è·ƒèŒƒå›´"
    echo " 0. è¿”å›"
    read -p " è¯·é€‰æ‹©: " mod_opt
    
    if [[ "$mod_opt" == "1" ]]; then
        echo "1. www.microsoft.com"
        echo "2. www.amazon.com"
        echo "3. www.tesla.com"
        read -p "æ–°ä¼ªè£… [1-3]: " idx
        case $idx in
            2) new="www.amazon.com" ;;
            3) new="www.tesla.com" ;;
            *) new="www.microsoft.com" ;;
        esac
        # ä¿®æ”¹é…ç½®æ–‡ä»¶
        sed -i "s/\"server_name\": \"$CAMOU_DEST\"/\"server_name\": \"$new\"/" $SB_CONFIG
        sed -i "s/\"server\": \"$CAMOU_DEST\"/\"server\": \"$new\"/" $SB_CONFIG
        # ä¿®æ”¹è®°å½•æ–‡ä»¶
        sed -i "s/CAMOU_DEST=.*/CAMOU_DEST=$new/" /etc/sing-box/info.txt
        echo -e "${GREEN}ä¼ªè£…å·²ä¿®æ”¹ä¸º: $new${PLAIN}"
        systemctl restart sing-box

    elif [[ "$mod_opt" == "2" ]]; then
        read -p "æ–°ä¸»ç«¯å£: " np
        read -p "æ–°è·³è·ƒèŒƒå›´ (å¦‚ 30000-40000, ç•™ç©ºåˆ™å…³é—­): " nr
        # ä¿®æ”¹é…ç½®æ–‡ä»¶
        sed -i "s/\"listen_port\": $HY2_PORT/\"listen_port\": $np/" $SB_CONFIG
        # é‡ç½® iptables
        iptables -t nat -F PREROUTING
        [[ -n "$nr" ]] && setup_port_hopping $np ${nr%-*} ${nr#*-}
        # ä¿®æ”¹è®°å½•æ–‡ä»¶
        sed -i "s/HY2_PORT=.*/HY2_PORT=$np/" /etc/sing-box/info.txt
        sed -i "s/PORT_RANGE=.*/PORT_RANGE=$nr/" /etc/sing-box/info.txt
        echo -e "${GREEN}ç«¯å£å·²ä¿®æ”¹ï¼${PLAIN}"
        systemctl restart sing-box
    fi
}

# ä¸»èœå•
show_menu() {
    # éšè—å‚æ•°: cleanup (ç”¨äº cron å®šæ—¶æ‰§è¡Œ)
    if [[ "$1" == "cleanup" ]]; then
        system_cleanup
        echo "å®šæ—¶æ¸…ç†å®Œæˆ $(date)" >> /var/log/sb_cleanup.log
        exit 0
    fi

    clear
    echo -e "=================================="
    echo -e "   Sing-box å®Œç¾ç®¡ç†è„šæœ¬ (V2.1)"
    echo -e "=================================="
    echo -e " 1. å®‰è£… / é‡è£… (æ•°æ®ä¼šé‡ç½®)"
    echo -e " 2. æŸ¥çœ‹èŠ‚ç‚¹é“¾æ¥"
    echo -e " 3. æŸ¥çœ‹è¿è¡Œæ—¥å¿—"
    echo -e " 4. ä¿®æ”¹èŠ‚ç‚¹é…ç½®"
    echo -e " 5. æ›´æ–° Sing-box å†…æ ¸"
    echo -e " 6. æ‰‹åŠ¨æ¸…ç†ç³»ç»Ÿåƒåœ¾"
    echo -e " 7. å¸è½½è„šæœ¬"
    echo -e " 0. é€€å‡º"
    echo -e "=================================="
    read -p " è¯·é€‰æ‹©: " num
    case "$num" in
        1) install_singbox ;;
        2) show_info ;;
        3) journalctl -u sing-box -f -n 20 ;;
        4) modify_config ;; 
        5) install_core && systemctl restart sing-box ;;
        6) system_cleanup; echo -e "${GREEN}æ¸…ç†å®Œæˆï¼${PLAIN}" ;;
        7) systemctl stop sing-box; rm -rf /etc/sing-box /usr/local/bin/sing-box /usr/local/bin/sb; echo -e "${GREEN}å¸è½½å®Œæˆ${PLAIN}" ;;
        0) exit 0 ;;
        *) echo -e "${RED}è¯·è¾“å…¥æ­£ç¡®é€‰é¡¹${PLAIN}" ;;
    esac
}

# è¿è¡Œèœå•
show_menu "$1"
