cat > /usr/local/bin/sb << 'EOF'
#!/bin/bash

# =========================================================
# Sing-box å®Œç¾åŒæ ¸ç‰ˆ (Reality + Hy2) - V2.0 ä¿®å¤ç‰ˆ
# =========================================================

# é¢œè‰²å®šä¹‰
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[36m"
PLAIN="\033[0m"

# æ ¸å¿ƒé…ç½®
SB_CONFIG="/etc/sing-box/config.json"
SB_BIN="/usr/local/bin/sing-box"
CERT_DIR="/root/cert"
DOMAIN_FILE="/etc/sing-box/domain.txt"
SCRIPT_PATH=$(readlink -f "$0")

# æ£€æŸ¥ Root
[[ $EUID -ne 0 ]] && echo -e "${RED}å¿…é¡» Root è¿è¡Œ${PLAIN}" && exit 1

# åŸºç¡€å‡½æ•°
install_dependencies() {
    # å¢åŠ  net-tools ä»¥ä¿®å¤ netstat æŠ¥é”™
    if [ -f /etc/debian_version ]; then
        apt update -y && apt install -y curl wget tar socat jq openssl cron iptables iptables-persistent net-tools
    elif [ -f /etc/redhat-release ]; then
        yum install -y curl wget tar socat jq openssl cronie iptables iptables-services net-tools
    fi
    mkdir -p /etc/sing-box
    systemctl enable cron >/dev/null 2>&1
    systemctl start cron >/dev/null 2>&1
}

system_cleanup() {
    # é€‚åˆåå°è¿è¡Œçš„é™é»˜æ¸…ç†
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y >/dev/null 2>&1
        apt-get clean >/dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y >/dev/null 2>&1
        yum clean all >/dev/null 2>&1
    fi
    rm -rf /tmp/*
    rm -rf /var/log/*.gz
    rm -rf /root/.npm
    rm -rf /root/.cache
    rm -f /tmp/sb.tar.gz
}

install_core() {
    LATEST_VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep 'tag_name' | cut -d\" -f4 | sed 's/v//')
    [[ -z "$LATEST_VER" ]] && echo "è·å–ç‰ˆæœ¬å¤±è´¥" && return 1
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH_STR="amd64" ;;
        aarch64) ARCH_STR="arm64" ;;
        *) echo "ä¸æ”¯æŒæ¶æ„" && return 1 ;;
    esac

    wget -O /tmp/sb.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VER}/sing-box-${LATEST_VER}-linux-${ARCH_STR}.tar.gz"
    tar -zxvf /tmp/sb.tar.gz -C /tmp
    mv /tmp/sing-box-${LATEST_VER}-linux-${ARCH_STR}/sing-box $SB_BIN
    chmod +x $SB_BIN
    rm -rf /tmp/sb.tar.gz /tmp/sing-box*
    echo -e "${GREEN}å†…æ ¸æ›´æ–°æˆåŠŸ v${LATEST_VER}${PLAIN}"
}

get_acme_cert() {
    local domain=$1
    echo -e "${BLUE}æ­£åœ¨ç”³è¯·è¯ä¹¦ (Let's Encrypt)...${PLAIN}"
    
    # 1. é‡Šæ”¾ç«¯å£
    if netstat -tuln | grep -q ":80 "; then
        systemctl stop nginx 2>/dev/null
        systemctl stop apache2 2>/dev/null
    fi

    # 2. å®‰è£… acme.sh
    curl https://get.acme.sh | sh
    ~/.acme.sh/acme.sh --upgrade --auto-upgrade
    
    # 3. å…³é”®ä¿®å¤ï¼šåˆ‡æ¢ CA å¹¶æ³¨å†Œè´¦å·ï¼Œé˜²æ­¢æŠ¥é”™
    ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
    ~/.acme.sh/acme.sh --register-account -m "admin@${domain}"

    # 4. ç”³è¯·è¯ä¹¦
    mkdir -p $CERT_DIR
    ~/.acme.sh/acme.sh --issue -d "$domain" --standalone --force
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}è¯ä¹¦ç”³è¯·å¤±è´¥ï¼è¯·æ£€æŸ¥åŸŸåè§£ææ˜¯å¦æ­£ç¡®ã€‚${PLAIN}"
        exit 1
    fi

    # 5. å®‰è£…è¯ä¹¦
    ~/.acme.sh/acme.sh --install-cert -d "$domain" --key-file $CERT_DIR/private.key --fullchain-file $CERT_DIR/cert.crt
    echo -e "${GREEN}è¯ä¹¦ç”³è¯·æˆåŠŸï¼${PLAIN}"
}

setup_port_hopping() {
    local port=$1
    local range_start=$2
    local range_end=$3
    iptables -t nat -F PREROUTING
    if [[ -n "$range_start" ]]; then
        iptables -t nat -A PREROUTING -p udp --dport ${range_start}:${range_end} -j REDIRECT --to-ports ${port}
    fi
    netfilter-persistent save 2>/dev/null || service iptables save 2>/dev/null
}

generate_config() {
    local domain=$1; local camou_dest=$2; local hy2_port=$3
    local hy2_pass=$4; local obfs_pass=$5; local uuid=$6
    local private_key=$7; local short_id=$8

    cat > $SB_CONFIG <<JSON
{
  "log": { "level": "info", "timestamp": true },
  "inbounds": [
    {
      "type": "vless",
      "tag": "vless-reality",
      "listen": "::",
      "listen_port": 443,
      "users": [{ "uuid": "$uuid", "flow": "xtls-rprx-vision" }],
      "tls": {
        "enabled": true,
        "server_name": "$camou_dest",
        "reality": {
          "enabled": true,
          "handshake": { "server": "$camou_dest", "server_port": 443 },
          "private_key": "$private_key",
          "short_id": ["$short_id"]
        }
      }
    },
    {
      "type": "hysteria2",
      "tag": "hy2-in",
      "listen": "::",
      "listen_port": $hy2_port,
      "users": [{ "password": "$hy2_pass" }],
      "obfs": { "type": "salamander", "password": "$obfs_pass" },
      "tls": {
        "enabled": true,
        "alpn": ["h3"],
        "certificate_path": "$CERT_DIR/cert.crt",
        "key_path": "$CERT_DIR/private.key"
      }
    }
  ],
  "outbounds": [{ "type": "direct", "tag": "direct" }]
}
JSON
}

setup_service() {
    cat > /etc/systemd/system/sing-box.service <<EOF
[Unit]
Description=sing-box service
After=network.target nss-lookup.target
[Service]
ExecStart=$SB_BIN run -c $SB_CONFIG
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable sing-box >/dev/null 2>&1
    systemctl restart sing-box
}

install_singbox() {
    install_dependencies
    install_core
    cp "$SCRIPT_PATH" /usr/local/bin/sb && chmod +x /usr/local/bin/sb

    read -p "è¯·è¾“å…¥ Hy2 åŸŸå: " domain
    [[ -z "$domain" ]] && exit 1
    echo "$domain" > $DOMAIN_FILE
    get_acme_cert "$domain"

    read -p "è®¾ç½® Hy2 ç«¯å£ (é»˜è®¤ 50000): " hy2_port
    [[ -z "$hy2_port" ]] && hy2_port=50000
    read -p "è®¾ç½®ç«¯å£è·³è·ƒèŒƒå›´ (å¦‚ 50000-50050): " port_range
    [[ -n "$port_range" ]] && setup_port_hopping $hy2_port ${port_range%-*} ${port_range#*-}

    hy2_pass=$(openssl rand -hex 8)
    obfs_pass=$(openssl rand -hex 8)

    echo "1. www.microsoft.com (æ¨è)"
    echo "2. www.amazon.com"
    echo "3. www.tesla.com"
    read -p "é€‰æ‹©ä¼ªè£… [1-3]: " dest_idx
    case $dest_idx in
        2) dest="www.amazon.com" ;;
        3) dest="www.tesla.com" ;;
        *) dest="www.microsoft.com" ;;
    esac

    kp=$($SB_BIN generate reality-keypair)
    pk=$(echo "$kp" | grep "PrivateKey" | cut -d: -f2 | tr -d ' "')
    pub=$(echo "$kp" | grep "PublicKey" | cut -d: -f2 | tr -d ' "')
    sid=$($SB_BIN generate rand --hex 8)
    uuid=$($SB_BIN generate uuid)

    generate_config "$domain" "$dest" "$hy2_port" "$hy2_pass" "$obfs_pass" "$uuid" "$pk" "$sid"
    setup_service
    
    cat > /etc/sing-box/info.txt <<EOF
DOMAIN=$domain
UUID=$uuid
PUBLIC_KEY=$pub
SHORT_ID=$sid
CAMOU_DEST=$dest
HY2_PORT=$hy2_port
HY2_PASS=$hy2_pass
OBFS_PASS=$obfs_pass
PORT_RANGE=$port_range
EOF
    
    # è‡ªåŠ¨æ·»åŠ æ¯å¤©å‡Œæ™¨3ç‚¹æ¸…ç†ä»»åŠ¡
    (crontab -l 2>/dev/null | grep -v "sb cleanup"; echo "0 3 * * * /usr/local/bin/sb cleanup") | crontab -
    
    echo -e "${GREEN}å®‰è£…å®Œæˆï¼å·²æ·»åŠ æ¯æ—¥è‡ªåŠ¨æ¸…ç†ä»»åŠ¡ã€‚${PLAIN}"
    show_info
}

show_info() {
    [[ ! -f /etc/sing-box/info.txt ]] && echo "è¯·å…ˆå®‰è£…" && return
    source /etc/sing-box/info.txt
    ip=$(curl -s4 icanhazip.com)
    vless="vless://${UUID}@${ip}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=${CAMOU_DEST}&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#VLESS-Reality"
    hy2="hysteria2://${HY2_PASS}@${DOMAIN}:${HY2_PORT}?sni=${DOMAIN}&alpn=h3&obfs=salamander&obfs-password=${OBFS_PASS}&insecure=0#Hy2-Link"

    echo -e "\n${BLUE}ğŸš€ VLESS-Reality${PLAIN}"
    echo -e "åœ°å€: ${ip}:443"
    echo -e "ä¼ªè£…: ${CAMOU_DEST}"
    echo -e "é“¾æ¥: ${vless}"
    echo -e "\n${BLUE}ğŸš€ Hysteria 2${PLAIN}"
    echo -e "åŸŸå: ${DOMAIN}"
    echo -e "ç«¯å£: ${HY2_PORT} (è·³è·ƒ: ${PORT_RANGE})"
    echo -e "å¯†ç : ${HY2_PASS}"
    echo -e "æ··æ·†: ${OBFS_PASS}"
    echo -e "é“¾æ¥: ${hy2}"
}

modify_config() {
    [[ ! -f /etc/sing-box/info.txt ]] && echo "è¯·å…ˆå®‰è£…" && return
    source /etc/sing-box/info.txt
    echo -e "\n${YELLOW}[ä¿®æ”¹é…ç½®]${PLAIN}"
    echo " 1. ä¿®æ”¹ Reality ä¼ªè£…åŸŸå"
    echo " 2. ä¿®æ”¹ Hy2 ç«¯å£/è·³è·ƒ"
    echo " 0. è¿”å›"
    read -p " é€‰æ‹©: " mod_opt
    
    if [[ "$mod_opt" == "1" ]]; then
        echo "1. www.microsoft.com"
        echo "2. www.amazon.com"
        echo "3. www.tesla.com"
        read -p "æ–°ä¼ªè£… [1-3]: " idx
        case $idx in
            2) new="www.amazon.com" ;;
            3) new="www.tesla.com" ;;
            *) new="www.microsoft.com" ;;
        esac
        sed -i "s/\"server_name\": \"$CAMOU_DEST\"/\"server_name\": \"$new\"/" $SB_CONFIG
        sed -i "s/\"server\": \"$CAMOU_DEST\"/\"server\": \"$new\"/" $SB_CONFIG
        sed -i "s/CAMOU_DEST=.*/CAMOU_DEST=$new/" /etc/sing-box/info.txt
        echo -e "${GREEN}ä¼ªè£…å·²æ”¹: $new${PLAIN}"
        systemctl restart sing-box

    elif [[ "$mod_opt" == "2" ]]; then
        read -p "æ–°ä¸»ç«¯å£: " np
        read -p "æ–°è·³è·ƒèŒƒå›´ (å¦‚ 30000-40000, ç•™ç©ºå…³é—­): " nr
        sed -i "s/\"listen_port\": $HY2_PORT/\"listen_port\": $np/" $SB_CONFIG
        iptables -t nat -F PREROUTING
        [[ -n "$nr" ]] && setup_port_hopping $np ${nr%-*} ${nr#*-}
        sed -i "s/HY2_PORT=.*/HY2_PORT=$np/" /etc/sing-box/info.txt
        sed -i "s/PORT_RANGE=.*/PORT_RANGE=$nr/" /etc/sing-box/info.txt
        echo -e "${GREEN}ç«¯å£å·²ä¿®æ”¹ï¼${PLAIN}"
        systemctl restart sing-box
    fi
}

show_menu() {
    if [[ "$1" == "cleanup" ]]; then
        system_cleanup
        exit 0
    fi

    clear
    echo -e "=================================="
    echo -e "   Sing-box ç®¡ç†è„šæœ¬ (å‘½ä»¤: sb)"
    echo -e "=================================="
    echo -e " 1. å®‰è£…/é‡è£…"
    echo -e " 2. æŸ¥çœ‹èŠ‚ç‚¹"
    echo -e " 3. æŸ¥çœ‹æ—¥å¿—"
    echo -e " 4. ä¿®æ”¹é…ç½® (ä¼ªè£…/ç«¯å£)"
    echo -e " 5. æ›´æ–°å†…æ ¸"
    echo -e " 6. ç³»ç»Ÿæ¸…ç†"
    echo -e " 7. å¸è½½"
    echo -e " 0. é€€å‡º"
    read -p " é€‰é¡¹: " num
    case "$num" in
        1) install_singbox ;;
        2) show_info ;;
        3) journalctl -u sing-box -f -n 20 ;;
        4) modify_config ;; 
        5) install_core && systemctl restart sing-box ;;
        6) system_cleanup; echo "æ¸…ç†å®Œæˆ" ;;
        7) systemctl stop sing-box; rm -rf /etc/sing-box /usr/local/bin/sing-box /usr/local/bin/sb; echo "å¸è½½å®Œæˆ" ;;
        0) exit 0 ;;
        *) echo "é”™è¯¯é€‰é¡¹" ;;
    esac
}
show_menu "$1"
EOF
chmod +x /usr/local/bin/sb
sb
