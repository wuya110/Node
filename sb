#!/bin/bash

# =========================================================
# Sing-box å®Œç¾ŽåŒæ ¸ç‰ˆ (Reality + Hysteria2)
# ç‰¹æ€§ï¼šå®˜æ–¹å†…æ ¸ | ACMEæ­£è§„è¯ä¹¦ | ç«¯å£è·³è·ƒ | æ™ºèƒ½æ¸…ç† | å¿«æ·å‘½ä»¤
# =========================================================

# é¢œè‰²å®šä¹‰
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[36m"
PLAIN="\033[0m"

# æ ¸å¿ƒé…ç½®
SB_CONFIG="/etc/sing-box/config.json"
SB_BIN="/usr/local/bin/sing-box"
CERT_DIR="/root/cert"
DOMAIN_FILE="/etc/sing-box/domain.txt"
SCRIPT_PATH=$(readlink -f "$0")

# æ£€æŸ¥ Root æƒé™
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼š${PLAIN} å¿…é¡»ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼\n" && exit 1

# -----------------------------------------------------------------------------
# åŸºç¡€åŠŸèƒ½å‡½æ•°
# -----------------------------------------------------------------------------

# 1. æ³¨å†Œå¿«æ·å‘½ä»¤ sb
install_shortcut() {
    cp "$SCRIPT_PATH" /usr/local/bin/sb
    chmod +x /usr/local/bin/sb
    echo -e "${GREEN}å¿«æ·å‘½ä»¤ 'sb' å·²å®‰è£…ï¼ä»¥åŽè¾“å…¥ sb å³å¯ç®¡ç†è„šæœ¬ã€‚${PLAIN}"
}

# 2. ç³»ç»Ÿåžƒåœ¾æ¸…ç†
system_cleanup() {
    echo -e "${BLUE}æ­£åœ¨æ‰§è¡Œç³»ç»Ÿæ¸…ç†...${PLAIN}"
    
    # æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y >/dev/null 2>&1
        apt-get clean >/dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y >/dev/null 2>&1
        yum clean all >/dev/null 2>&1
    fi

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf /tmp/*
    rm -rf /var/log/*.gz
    rm -rf /root/.npm
    rm -rf /root/.cache
    
    # æ¸…ç† Sing-box å®‰è£…åŒ…ç¼“å­˜
    rm -f /tmp/sing-box.tar.gz
    
    echo -e "${GREEN}ç³»ç»Ÿåžƒåœ¾æ¸…ç†å®Œæˆï¼VPS æ›´è½»å¿«äº†ã€‚${PLAIN}"
}

# 3. å®‰è£…ä¾èµ–
install_dependencies() {
    echo -e "${BLUE}æ­£åœ¨å®‰è£…å¿…è¦ä¾èµ–...${PLAIN}"
    if [ -f /etc/debian_version ]; then
        apt update -y && apt install -y curl wget tar socat jq openssl cron iptables iptables-persistent
    elif [ -f /etc/redhat-release ]; then
        yum install -y curl wget tar socat jq openssl cronie iptables iptables-services
    else
        echo -e "${RED}ç³»ç»Ÿä¸æ”¯æŒï¼Œä»…æ”¯æŒ Debian/Ubuntu/CentOS${PLAIN}"
        exit 1
    fi
    mkdir -p /etc/sing-box
}

# 4. å®‰è£…/æ›´æ–°å®˜æ–¹å†…æ ¸
install_core() {
    echo -e "${BLUE}æ­£åœ¨æ£€æŸ¥ Sing-box å®˜æ–¹æœ€æ–°ç‰ˆæœ¬...${PLAIN}"
    LATEST_VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep 'tag_name' | cut -d\" -f4 | sed 's/v//')
    if [[ -z "$LATEST_VER" ]]; then
        echo -e "${RED}èŽ·å–ç‰ˆæœ¬å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥${PLAIN}"
        return 1
    fi
    
    echo -e "${GREEN}æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: v${LATEST_VER}${PLAIN}"
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH_STR="amd64" ;;
        aarch64) ARCH_STR="arm64" ;;
        *) echo -e "${RED}ä¸æ”¯æŒçš„æž¶æž„: $ARCH${PLAIN}"; return 1 ;;
    esac

    DOWNLOAD_URL="https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VER}/sing-box-${LATEST_VER}-linux-${ARCH_STR}.tar.gz"
    
    wget -O /tmp/sing-box.tar.gz "$DOWNLOAD_URL"
    tar -zxvf /tmp/sing-box.tar.gz -C /tmp
    mv /tmp/sing-box-${LATEST_VER}-linux-${ARCH_STR}/sing-box $SB_BIN
    chmod +x $SB_BIN
    rm -rf /tmp/sing-box*
    
    echo -e "${GREEN}Sing-box v${LATEST_VER} å®‰è£…æˆåŠŸï¼${PLAIN}"
}

# 5. ç”³è¯·è¯ä¹¦
get_acme_cert() {
    local domain=$1
    echo -e "${BLUE}æ­£åœ¨å‡†å¤‡ç”³è¯· SSL è¯ä¹¦...${PLAIN}"
    
    # ä¸´æ—¶é‡Šæ”¾ 80 ç«¯å£
    if netstat -tuln | grep -q ":80 "; then
        systemctl stop nginx 2>/dev/null
        systemctl stop apache2 2>/dev/null
    fi

    curl https://get.acme.sh | sh
    ~/.acme.sh/acme.sh --upgrade --auto-upgrade
    
    mkdir -p $CERT_DIR
    ~/.acme.sh/acme.sh --issue -d "$domain" --standalone --force
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}è¯ä¹¦ç”³è¯·å¤±è´¥ï¼è¯·æ£€æŸ¥åŸŸåè§£æžã€‚${PLAIN}"
        exit 1
    fi

    ~/.acme.sh/acme.sh --install-cert -d "$domain" \
        --key-file       $CERT_DIR/private.key  \
        --fullchain-file $CERT_DIR/cert.crt
    
    echo -e "${GREEN}è¯ä¹¦ç”³è¯·æˆåŠŸï¼${PLAIN}"
}

# 6. é…ç½®ç«¯å£è·³è·ƒ
setup_port_hopping() {
    local port=$1
    local range_start=$2
    local range_end=$3
    
    echo -e "${BLUE}é…ç½® iptables ç«¯å£è·³è·ƒ...${PLAIN}"
    iptables -t nat -F PREROUTING
    iptables -t nat -A PREROUTING -p udp --dport ${range_start}:${range_end} -j REDIRECT --to-ports ${port}
    netfilter-persistent save 2>/dev/null || service iptables save 2>/dev/null
}

# 7. ç”Ÿæˆé…ç½®
generate_config() {
    local domain=$1; local camou_dest=$2; local hy2_port=$3
    local hy2_pass=$4; local obfs_pass=$5; local uuid=$6
    local private_key=$7; local short_id=$8

    cat > $SB_CONFIG <<EOF
{
  "log": { "level": "info", "timestamp": true },
  "inbounds": [
    {
      "type": "vless",
      "tag": "vless-reality",
      "listen": "::",
      "listen_port": 443,
      "users": [{ "uuid": "$uuid", "flow": "xtls-rprx-vision" }],
      "tls": {
        "enabled": true,
        "server_name": "$camou_dest",
        "reality": {
          "enabled": true,
          "handshake": { "server": "$camou_dest", "server_port": 443 },
          "private_key": "$private_key",
          "short_id": ["$short_id"]
        }
      }
    },
    {
      "type": "hysteria2",
      "tag": "hy2-in",
      "listen": "::",
      "listen_port": $hy2_port,
      "users": [{ "password": "$hy2_pass" }],
      "obfs": { "type": "salamander", "password": "$obfs_pass" },
      "tls": {
        "enabled": true,
        "alpn": ["h3"],
        "certificate_path": "$CERT_DIR/cert.crt",
        "key_path": "$CERT_DIR/private.key"
      }
    }
  ],
  "outbounds": [{ "type": "direct", "tag": "direct" }]
}
EOF
}

# 8. è®¾ç½®å¼€æœºè‡ªå¯æœåŠ¡
setup_service() {
    cat > /etc/systemd/system/sing-box.service <<EOF
[Unit]
Description=sing-box service
Documentation=https://sing-box.sagernet.org
After=network.target nss-lookup.target

[Service]
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
ExecStart=$SB_BIN run -c $SB_CONFIG
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable sing-box >/dev/null 2>&1
    systemctl restart sing-box
    echo -e "${GREEN}å¼€æœºè‡ªå¯æœåŠ¡å·²é…ç½®ï¼${PLAIN}"
}

# -----------------------------------------------------------------------------
# äº¤äº’æµç¨‹
# -----------------------------------------------------------------------------

install_singbox() {
    clear
    echo -e "==================================================="
    echo -e "    ${GREEN}Sing-box å®Œç¾ŽåŒæ ¸å®‰è£… (Reality + Hy2)${PLAIN}"
    echo -e "==================================================="
    
    install_shortcut
    install_dependencies
    install_core

    # Hy2 åŸŸå
    echo -e "\n${YELLOW}[Hysteria 2 è®¾ç½®]${PLAIN}"
    read -p "è¯·è¾“å…¥è§£æžåˆ°æœ¬æœºçš„åŸŸå: " domain
    [[ -z "$domain" ]] && exit 1
    echo "$domain" > $DOMAIN_FILE
    get_acme_cert "$domain"

    # Hy2 ç«¯å£ä¸Žè·³è·ƒ
    read -p "è®¾ç½® Hy2 ä¸»ç«¯å£ (é»˜è®¤ 50000): " hy2_port
    [[ -z "$hy2_port" ]] && hy2_port=50000
    read -p "è®¾ç½®ç«¯å£è·³è·ƒèŒƒå›´ (å¦‚ 50000-50050ï¼Œç•™ç©ºè·³è¿‡): " port_range
    [[ -n "$port_range" ]] && setup_port_hopping $hy2_port ${port_range%-*} ${port_range#*-}

    # å¯†ç  (ä½¿ç”¨ hex é¿å…ç‰¹æ®Šå­—ç¬¦)
    hy2_pass=$(openssl rand -hex 8)
    obfs_pass=$(openssl rand -hex 8)

    # Reality è®¾ç½®
    echo -e "\n${YELLOW}[VLESS-Reality è®¾ç½®]${PLAIN}"
    echo "1. www.microsoft.com (æŽ¨è)"
    echo "2. www.amazon.com"
    echo "3. www.tesla.com"
    echo "4. gateway.icloud.com"
    read -p "é€‰æ‹©ä¼ªè£… [1-4] (é»˜è®¤1): " dest_idx
    case $dest_idx in
        2) dest="www.amazon.com" ;;
        3) dest="www.tesla.com" ;;
        4) dest="gateway.icloud.com" ;;
        *) dest="www.microsoft.com" ;;
    esac

    # ç”Ÿæˆå¯†é’¥
    kp=$($SB_BIN generate reality-keypair)
    pk=$(echo "$kp" | grep "PrivateKey" | cut -d: -f2 | tr -d ' "')
    pub=$(echo "$kp" | grep "PublicKey" | cut -d: -f2 | tr -d ' "')
    sid=$($SB_BIN generate rand --hex 8)
    uuid=$($SB_BIN generate uuid)

    # å¯åŠ¨
    generate_config "$domain" "$dest" "$hy2_port" "$hy2_pass" "$obfs_pass" "$uuid" "$pk" "$sid"
    setup_service
    
    # ä¿å­˜ä¿¡æ¯
    cat > /etc/sing-box/info.txt <<EOF
DOMAIN=$domain
UUID=$uuid
PUBLIC_KEY=$pub
SHORT_ID=$sid
CAMOU_DEST=$dest
HY2_PORT=$hy2_port
HY2_PASS=$hy2_pass
OBFS_PASS=$obfs_pass
PORT_RANGE=$port_range
EOF

    system_cleanup
    echo -e "${GREEN}å®‰è£…å®Œæˆï¼${PLAIN}"
    show_info
}

show_info() {
    [[ ! -f /etc/sing-box/info.txt ]] && echo "è¯·å…ˆå®‰è£…" && return
    source /etc/sing-box/info.txt
    ip=$(curl -s4 icanhazip.com)

    vless="vless://${UUID}@${ip}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni=${CAMOU_DEST}&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp&headerType=none#VLESS-Reality"
    hy2="hysteria2://${HY2_PASS}@${DOMAIN}:${HY2_PORT}?sni=${DOMAIN}&alpn=h3&obfs=salamander&obfs-password=${OBFS_PASS}&insecure=0#Hy2-Link"

    echo -e "\n${BLUE}ðŸš€ VLESS-Reality${PLAIN}"
    echo -e "åœ°å€: ${ip}:443"
    echo -e "ä¼ªè£…: ${CAMOU_DEST}"
    echo -e "é“¾æŽ¥: ${vless}"

    echo -e "\n${BLUE}ðŸš€ Hysteria 2${PLAIN}"
    echo -e "åŸŸå: ${DOMAIN}"
    echo -e "ç«¯å£: ${HY2_PORT} (è·³è·ƒ: ${PORT_RANGE})"
    echo -e "å¯†ç : ${HY2_PASS}"
    echo -e "æ··æ·†: ${OBFS_PASS}"
    echo -e "é“¾æŽ¥: ${hy2}"
}

# èœå•
show_menu() {
    clear
    echo -e "=================================="
    echo -e "   Sing-box ç®¡ç†è„šæœ¬ (å‘½ä»¤: sb)"
    echo -e "=================================="
    echo -e " 1. å®‰è£…/é‡è£… (å®Œç¾ŽåŒåè®®)"
    echo -e " 2. æŸ¥çœ‹èŠ‚ç‚¹é“¾æŽ¥"
    echo -e " 3. æŸ¥çœ‹æ—¥å¿—"
    echo -e " 4. ä¿®æ”¹é…ç½® (ä¼ªè£…/ç«¯å£)"
    echo -e " 5. æ›´æ–°å†…æ ¸"
    echo -e " 6. ç³»ç»Ÿåžƒåœ¾æ¸…ç†"
    echo -e " 7. å¸è½½"
    echo -e " 0. é€€å‡º"
    read -p " é€‰é¡¹: " num
    case "$num" in
        1) install_singbox ;;
        2) show_info ;;
        3) journalctl -u sing-box -f -n 20 ;;
        4) echo "åŠŸèƒ½å¼€å‘ä¸­..." ;; 
        5) install_core && systemctl restart sing-box ;;
        6) system_cleanup ;;
        7) systemctl stop sing-box; rm -rf /etc/sing-box /usr/local/bin/sing-box /usr/local/bin/sb; echo "å¸è½½å®Œæˆ" ;;
        0) exit 0 ;;
        *) echo "é”™è¯¯é€‰é¡¹" ;;
    esac
}

show_menu
